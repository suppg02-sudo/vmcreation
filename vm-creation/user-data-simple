#cloud-config
# Minimal SSH configuration for guaranteed access

# Enable password authentication
ssh_pwauth: true

# Set root password - simple and direct
chpasswd:
  expire: false
  list: |
    root:Passw0rd

# Basic packages
package_update: true
packages:
  - openssh-server
  - curl
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Simple run commands
runcmd:
  # Set password
  - echo "root:Passw0rd" | chpasswd

  # Start SSH
  - systemctl enable ssh
  - systemctl start ssh

  # Configure SSH minimally
  - sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  - sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart ssh

  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl start docker
  - systemctl enable docker
  - usermod -aG docker root

  # Log success
  - echo "SSH setup complete - root:Passw0rd" >> /root/ssh-setup.log
  - echo "Docker setup complete" >> /root/docker-setup.log